# K3s Deployment

For local testing a Lightweight Kubernetes cluster is used. [K3s](https://k3s.io/) is a lightweight Kubernetes distribution that is easy to install and manage. It is designed for resource-constrained environments and is ideal for local development and testing.

## Install K3s

```bash
curl -sfL https://get.k3s.io | sh - 
# Check for Ready node, takes ~30 seconds 
sudo k3s kubectl get node 
```

## Helm

Helm >=3.6 CLI is required to install MLRun. If you don't have it installed, you can do so with the following command:

```bash
curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
chmod 700 get_helm.sh
./get_helm.sh
```

## Test Kubernetes

```bash
sudo kubectl get nodes
```

## cert-manager

### Install cert-manager

```bash
# Add the Helm repository for trust-manager
sudo helm repo add jetstack https://charts.jetstack.io
sudo helm repo update

#sudo kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.18.2/cert-manager.crds.yaml

# Apply the cert-manager manifest to install it
#sudo kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.18.2/cert-manager.yaml

# https://cert-manager.io/docs/installation/kubectl/#verify
sudo helm install \
  cert-manager jetstack/cert-manager \
  --kubeconfig /etc/rancher/k3s/k3s.yaml \
  --namespace cert-manager \
  --create-namespace \
  --version v1.18.2 \
  --set crds.enabled=true

# sudo helm install \
#   cert-manager \
#   jetstack/cert-manager \
#   --kubeconfig /etc/rancher/k3s/k3s.yaml \
#   --namespace cert-manager \
#   --create-namespace \
#   --version 1.18.2 \
#   --wait

# Install trust-manager
sudo helm install trust-manager jetstack/trust-manager \
  --kubeconfig /etc/rancher/k3s/k3s.yaml \
  --namespace cert-manager \
  --create-namespace \
  --version 0.18.0 \
  --wait

# Verify the installation by checking the pods in the cert-manager namespace
# Wait until all pods are in the "Running" state
sudo kubectl get pods -n cert-manager
```

### Create a Cluster-Wide Certificate Authority

```bash
# Create a file named cluster-issuer.yaml
cat > cluster-issuer.yaml <<EOF
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: selfsigned-ca
spec:
  selfSigned: {}
EOF

# Apply the issuer to the cluster
sudo kubectl apply -f cluster-issuer.yaml

```bash
# Create a file named registry-certificate.yaml
cat > ca-certificate.yaml <<EOF
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: ca-key-pair
  namespace: cert-manager
spec:
  isCA: true
  commonName: my-ca
  secretName: ca-key-pair
  issuerRef:
    name: selfsigned-ca
    kind: ClusterIssuer
EOF

# Request the certificate
sudo kubectl apply -f ca-certificate.yaml

cat > trust-bundle.yaml <<EOF
# This apiVersion MUST match the CRD version installed by the Helm chart.
apiVersion: trust.cert-manager.io/v1alpha1
kind: Bundle
metadata:
  name: selfsigned-ca-bundle
spec:
  sources:
    - secret:
        name: "ca-key-pair"
        key: "ca.crt"
  target:
    configMap:
      key: "ca-certificates.crt"
    namespaceSelector: {}
EOF

sudo kubectl apply -f trust-bundle.yaml


# Wait a few seconds for cert-manager to process it
echo "Waiting for cert-manager to create the CA secret..."
sleep 5




---

echo "Verifying that 'ca-key-pair' secret now exists..."
sudo kubectl get secret ca-key-pair -n cert-manager
```


```
  sudo kubectl get crd bundles.trust.cert-manager.io
```



### Configure Trust Distribution

```bash
# Create a file named trust-bundle.yaml
cat > trust-bundle.yaml <<EOF
# This apiVersion MUST match the CRD version installed by the Helm chart.
apiVersion: trust.cert-manager.io/v1alpha1
kind: Bundle
metadata:
  name: selfsigned-ca-bundle
spec:
  sources:
    - secret:
        name: "ca-key-pair"
        key: "ca.crt"
  target:
    configMap:
      key: "ca-certificates.crt"
    namespaceSelector: {}
EOF

# Apply the trust bundle configuration
sudo kubectl apply -f trust-bundle.yaml
```
